version: '3.8'

services:
  # 1. Setup Phase: Generate Keys
  setup:
    build: .
    command: ["keygen"]
    working_dir: /data
    volumes:
      - keys_volume:/data

  # 2. Server
  server:
    build: .
    command: ["secure_server", "-timeout", "35s"]
    working_dir: /data
    ports:
      - "5900:5900"
    volumes:
      - keys_volume:/data
    depends_on:
      setup:
        condition: service_completed_successfully
    networks:
      - ironhouse

  # 3. Client
  client:
    build: .
    # Wait for server, then run
    command: ["sh", "-c", "sleep 2 && secure_client -duration 30s"]
    working_dir: /data
    volumes:
      - keys_volume:/data
    environment:
      - ZMQ_SERVER_ADDR=tcp://server:5900
    depends_on:
      server:
        condition: service_started
    networks:
      - ironhouse

networks:
  ironhouse:

volumes:
  keys_volume: